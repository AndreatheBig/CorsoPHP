# Php PDO: PHP Data Object 

La classe PDO è stata introdotta a partire dalla versione 5.1 di PHP e permette la connessione a diversi DBMS (MySQL, SQLite, PostgreSQL, Oracle, ...).

Con l'estensione PDO possiamo usare diversi metodi per interagire col database.

## Effettuare la connessione

PDO supporta solo la programmazione OOP. Per effettuare la connessione occorre creare una nuova istanza della classe PDO.

```php

// database connection
try{
	$DB = new PDO("mysql:host=$dbhost;dbname=$dbname",$dbuser,$dbpass);
}
catch(PDOException $e) {
	echo "Impossibile connettersi: ". $e->getMessage();
}
```

## Effettuare una richiesta

```php
//select
$sql = "SELECT titolo FROM libri ORDER BY titolo";
$query = $DB->query($sql);

```

## Ricevere i dati: Php PDO Fetch methods

Php PDO dispone dei metodi **PDO::fetch()**, sono generalmente utilizzati per ricevere dati dal database.

* PDO::FETCH_ASSOC

```php
/*Prove di PDO::fetch*/¶
$stmt = $DB->prepare("SELECT nome, cognome FROM studenti");
$stmt->execute();
echo ("PDO::FETCH_ASSOC: ");
echo ("Ritorna la riga successiva come array indicizzato per  nome colonna\n");
$result = $stmt->fetch(PDO::FETCH_ASSOC);
print_r($result);
echo ("\n");
```  
 
```php
    // Fetch using associative array.
    //Analogo al deprecato mysql_fetch_assoc
    $query->setFetchMode(PDO::FETCH_ASSOC);
    while($result = $query->fetch()){
    print_r($result);
}
```

* PDO::FETCH_NUM

```php 
    // Fetch as numeric array.
    $query->setFetchMode(PDO::FETCH_NUM);
    while($result = $query->fetch()){
    print_r($result);
}
```

* PDO::FETCH_BOTH

```php
    // Fetch as associative array and numeric array both.
    //Analogo al deprecato mysql_fetch_array 
    $query->setFetchMode(PDO::FETCH_BOTH);
    while($result = $query->fetch()){
    print_r($result);
}
```

```
echo ("PDO::FETCH_BOTH: ");
echo ("Ritorna la riga successiva come array indicizzato per  nome e numero di colonna\n");
$result = $stmt->fetch(PDO::FETCH_BOTH);
print_r($result);
echo ("\n");
```
* PDO::FETCH_OBJ 

```php
    // Fetch as object.
    //Analogo al deprecato mysql_fetch_obj 
    $query->setFetchMode(PDO::FETCH_OBJ);
    while($result = $query->fetch()){
    print_r($result);
}
```

```php
echo ("PDO::FETCH_OBJ: ");
echo ("Ritorna la riga successiva come oggetto anonimo con i nomi delle colonne come proprietà \n");
$result = $stmt->fetch(PDO::FETCH_OBJ);
print $result->name;
echo ("\n");
```

* PDO::FETCH_LAZY
```php
echo ("PDO::FETCH_LAZY: ");
echo ("Ritorna la riga successiva come oggetto anonimo con i nomi delle colonne come proprietà \n");
$result = $stmt->fetch(PDO::FETCH_LAZY);
print_r($result);
echo ("\n");
```

* PDO::FETCH_BOUND 
* PDO::FETCH_CLASS 
* PDO::FETCH_INTO 

* PDO::FETCH_NAMED



## Esempio - CRUD su tabella studente con PDO

connection.php

```php
try {
$con = new PDO("mysql:host=localhost;dbname=ITS2017","root","");

}catch(PDOException $e){
	
	echo $e->getMessage();
}
```

### Esempio - CRUD su tabella studente con PDO - setFetchMode

```php

class Studente {
	
	public $id;
	public $nome;
	public $matricola;

}


include("connection.php");

try{
	$result =  $con->query("SELECT * FROM studenti");
		
		$result->setFetchMode(PDO::FETCH_CLASS , "Studente");
		
	while($studente = $result->fetch()){
		
		echo "ID : $studente->id Nome : $studente->nome   Matricola: $studente->matricola <br>";
		
	}
	
}
catch(PDOException $ex){
	echo $ex->getMessage();
}
```

### Esempio - CRUD su tabella studente con PDO - CREATE

```php
include("connection.php");

try{
	$stmt =  $con->prepare("INSERT INTO studenti (nome,matricola) VALUES(:nome , :matricola)");
	
	$nome = "Studente";
	$matricola = "123456789";
	
	$stmt->bindParam(":nome" , $nome , PDO::PARAM_STR);
	$stmt->bindParam(":matricola" , $matricola , PDO::PARAM_STR);
	
	if($stmt->execute()){
		
		echo "Inserita la riga con id : " . $con->lastInsertId();
		
	}
	
	
}
catch(PDOException $ex){
	echo $ex->getMessage();
}
```

### Esempio - CRUD su tabella studente con PDO - RETRIEVE

```php
include("connection.php");

try{
	$result =  $con->query("SELECT * FROM studenti");
		
		$studenti = $result->fetchAll();
		
	foreach($studenti as $studente){
		
		echo "Name : $studente[name]   Matricola: $studente[matricola] <br>";
		
	}
	echo "Numero di righe ritornate: " . count($studenti);
	
	
}
catch(PDOException $ex){
	echo $ex->getMessage();
}


```

### Esempio - CRUD su tabella studente con PDO - UPDATE
```php

include("connection.php");

try{
	$stmt =  $con->prepare("UPDATE studenti SET nome=:nome , matricola=:matricola WHERE id=:id");
	
	$nome = "StudenteTest";
	$matricola = "987654321";
	$id = 1;
	
	$stmt->bindParam(":nome" , $nome , PDO::PARAM_STR);
	$stmt->bindParam(":matricola" , $matricola , PDO::PARAM_STR);
	$stmt->bindParam(":id" , $id , PDO::PARAM_INT);
	
	 if($stmt->execute()){
		 
		 echo "Aggiornati ".$stmt->rowCount() . " record della tabella studenti!!";
		 
	 }
	
	
}
catch(PDOException $ex){
	echo $ex->getMessage();
}


```



### Esempio - CRUD su tabella studente con PDO - DELETE
```php

include("connection.php");

try{
	$stmt =  $con->prepare("DELETE FROM studenti WHERE id=:id");
	
	$id = 1;
	
	$stmt->bindParam(":id" , $id , PDO::PARAM_INT);
	
	 if($stmt->execute()){
		 
		 echo $stmt->rowCount() . " Studente eliminato!!";
		 
	 }
	
	
}
catch(PDOException $ex){
	echo $ex->getMessage();
}


```


### Esempio - CRUD su tabella studente con PDO - prepared statements
```php

class Studente {
	
	public $id;
	public $nome;
	public $matricola;

}


include("connection.php");

try{
	$stmt =  $con->prepare("SELECT * FROM studenti WHERE id=:id");
	
	//1 previeni SQL Injection
	$id = "2; DELETE FROM studenti WHERE id='1'";
	
	//2 previeni SQL Injection
	$stmt->bindParam(":id" , $id , PDO::PARAM_INT);
	
	$stmt->execute();
		
		$stmt->setFetchMode(PDO::FETCH_CLASS , "Studente");
		
	while($student = $stmt->fetch()){
		
		echo "ID : $student->id Nome : $student->nome   Matricola: $student->matricola <br>";
		
	}
	
}
catch(PDOException $ex){
	echo $ex->getMessage();
}


```